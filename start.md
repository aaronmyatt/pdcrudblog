# Start
Any pipe can be executed as a server. Run this pipe locally with: `deno run -A --unstable-kv .pd/start/server.ts`

## Index Page
We will use a [blog template](https://github.com/davidgrzyb/tailwind-blog-template/tree/master) to make our lives easier.

- route: /
- ```ts
    const page = await Deno.readTextFile('./html/index.html')
    input.body = page;
    input.responseOptions.headers['content-type'] = 'text/html; charset=utf-8'
    ```

## Post page
This post template is also from the [blog template](https://github.com/davidgrzyb/tailwind-blog-template/tree/master)

- route: /post/*
- ```ts
    const page = await Deno.readTextFile('./html/post.html')
    input.body = page;
    input.responseOptions.headers['content-type'] = 'text/html; charset=utf-8'
    ```

## Form
This is just a [form component from TailwindUI](https://tailwindui.com/components/application-ui/forms/form-layouts) wrapped in the blog layout, take a look inside: [[formPage]]

- route: /form/*
- ```ts
    import formPage from 'formPage'
    const { layout } = await formPage.process();
    input.body = layout;
    input.responseOptions.headers['content-type'] = 'text/html; charset=utf-8'
    ```

## APIWrite
Pass requests to [[postStore]] mapping the request path to a write action.

`const action = $p.get(input, '/route/pathname/groups/action')`
`const output = await postStore.process({post: {[action]: input.payload}})`

Note the use of `Response.redirect` to load the index page after submission rather than serving an empty JSON object.

- route: /api/:action(create|update|delete)
- ```ts
    import postStore from 'postStore'

    input.payload = {};
    const action = $p.get(input, '/route/pathname/groups/action')

    try {
        const formData = await input.request.formData()
        input.payload =  Object.fromEntries(formData)

        const url = new URL(input.request.url)
        input.response = Response.redirect(url.origin)
    } catch(e) {
        // not form data
    } finally {
        const { post } = await postStore.process({post: {[action]: input.payload}})
        input.body = post;
    }
    ```

## APIRead
Pass requests to [[postStore]] mapping the request to a read action.

- route: /api/:action(list|read)
- ```ts
    const action = $p.get(input, '/route/pathname/groups/action')

    if(action === 'list'){
        const output = await postStore.process({post: {list: {}}})
        input.body = output.posts
    }
    if(action === 'read'){
        const {slug} = await input.request.json()
        const output = await postStore.process({post: {read: {slug}}})
        input.body = output.post;
        console.log(input);
    }
    ```

[//begin]: # "Autogenerated link references for markdown compatibility"
[formPage]: formPage.md "FormPage"
[postStore]: postStore.md "postStore"
[//end]: # "Autogenerated link references"